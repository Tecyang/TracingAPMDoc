# 微服务架构体系下监控系统调研

---

## 背景

微服务架构是目前各大互联网公司普遍采用的软件架构方式。在微服务架构中，系统被拆分为多个小的、相互独立的服务，这些服务运行在自己的进程中，可以独立的开发和部署。在业务快速变化时，微服务单一职责、自治的特点，使系统的边界更加清晰，提升了系统的可维护性；同时，简化了系统部署的复杂度，可以针对某个微服务单独升级和发布；在业务增长时，也可以方便的进行独立扩展。

微服务架构虽然带来了很多好处，但也带来了新的问题。在以往的单体应用中，排查问题往往通过查看日志定位错误信息和异常堆栈；但是在微服务架构中服务繁多，出现问题时的问题定位变得非常困难。另外，微服务往往通过组合已有的服务来创建新服务，一个服务的故障很可能会产生雪崩效应，导致整个系统的不可用。因此，如何监控微服务的运行状况、当出现异常时能快速给出报警，这给开发人员带来很大挑战。

本文基于公司当前实际需求情况,对不同的监控系统进行调研。

## 监控系统概要

### 功能划分

应用机器的资源报警叫做监控；业务功能模块的日志报错信息叫做监控；一个APM的条件触发也叫监控。分布式系统错综复杂，做个统计指标的集合展示，也叫做监控;理清其中的关系，是我们建立合理的监控体系的前提。  

> __APM (Application Performance Management)__ 在信息技术和系统管理领域中，应用性能管理 (APM)是监测和管理性能及可用性的软件应用程序。

一般来说，我们习惯按照两种不同的维度进行监控系统的划分：

![监控系统划分](监控系统划分.png)

__数据维度__ 从数据类型划分，大体可以分为：

* __日志（logs)__  用于记录离散的事件信息。例如，应用程序的调试信息或错误信息。它是我们诊断问题的依据。比如我们说的ELK就是基于Logging。  

* __指标（Metrics)__  基于时间序列的数据点，通过聚合和计算后能反应出一些重要指标的趋势。例如，队列的当前深度可被定义为一个度量值，在元素入队或出队时被更新；HTTP 请求个数可被定义为一个计数器，新请求到来时进行累。prometheus专注于Metrics领域。

* __调用链（Tracing）__ 调用链监控可以完整的呈现出一次请求的全部信息，包括服务调用链路、所耗时间等。如zipkin、skywalking等；

__功能维度__ 从业务功能维度划分，可以分为：基础监控、中间件监控、业务监控

* __基础监控__ 如健康检查等一类云平台（框架）等基础设施提供的能力，对于应用是否正常提供服务的监控；
* __中间件监控__ 对于不同的应用中间件是否正常运行的监控；
* __业务监控__ 对于不同的业务功能是否正常处理业务逻辑的监控；

一般现在的监控系统，都是按照数据维度划分进行设计的：

![分布式追踪系统划分](分布式追踪系统划分.png)

我们可以粗略的按照以上数据维度及划分标准，将现有的监控系统进行分类。例如，prometheus最初只是作为一个监控系统项目启动的，随着时间的推移，它可能会向跟踪方向发展，从而进入请求范围(request-scope)内的监控，但很可能不会深入到日志空间。ELK提供日志记录和汇总功能，使其成为可聚合的事件空间，但似乎在metrics和tracing领域不断积累更多的功能，意图将它推向中心

### 一般实现模块

不管什么样的监控系统，又涉及以下几个模块过程：

![监控系统模块](监控系统模块.png)

* __数据收集__ 如何在广度和效率上继续数据归并；
* __数据加工__ 数据的整理、传输和存储；
* __特征提取__ 大数据计算，中间结果生成存储；
* __数据展示__ 高颜值，多功能显示；

### 调研方向内容概述

后续调研，主要针对基于微服务架构体系下，对于应用的 Tracing 进行监控的不同方案展开。针对不同的实现方案，进行上述各实现模块的简单原理调研，分析总结各方案在三大功能指标方面的情况及优缺点。

### OpenTracing API 规范

提到对于应用Tracing的监控，就必须说一下 [OpenTracing](https://opentracing.io/) 规范。由于整个信息系统的快速发展，对于信息系统的不同监控实现、思路整体没有完整的规范体系，经常会有不同的监控系统实现 API 互不兼容，且很多对于应用系统存在很强的侵入性。开发人员对将其多语言系统与任何特定的分布式跟踪实现紧密耦合感到不安，但这些许多不同跟踪系统的应用程序级检测API具有非常相似的语义。基于此，衍生出了 OpenTracing 。

通过为流行的平台提供一致的，富有表现力的，供应商中立的API，OpenTracing使开发人员可以轻松地通过配置更改，添加（或切换）跟踪系统的实现。OpenTracing还为OSS检测和特定于平台的跟踪帮助程序库提供了通用语言。

大多数分布式追踪系统的思想模型都来自 Google's Dapper 论文， OpenTracing 也使用相似的术语

![监控术语](监控术语.png)


###

## 典型实现
